# 你好凸啊II

## Description

维护一个动态点凸包，支持以下几种操作

1. 将点$(x,y)$插入凸包。

   先输出`insert: `，然后输出插入后凸包上的点数。

2. 判断点$(x,y)$在凸包内/在凸包上/在凸包外。

   先输出`relation:`，然后输出`in/on/out`。

3. 询问点$(x,y)$与凸包上点的点积最大值。

   先输出`dotmax: `然后输出点数$k$和点积最大值。

   在接下来的$k$行中每行输出一个点的坐标。

4. 询问点$(x,y)$与凸包上点的叉积最大值。

   先输出`crxmax: `然后输出点数$k$和叉积最大值。

   在接下来的$k$行中每行输出一个点的坐标。

5. 询问点$(x,y)$到凸包的切线。

   先输出`left tangent: `然后输出左切线上的凸包顶点数量$k$，然后在接下来$k$行输出顶点坐标。

   先输出`right tangent: `然后输出右切线上的凸包顶点数量$k$，然后在接下来$k$行输出顶点坐标。

6. 询问直线$(x_1,y_1)-(x_2,y_2)$与凸包有无交点。

   若直线不与凸包相交，输出`intersection: none`。

   若直线与凸包交于$1$点，输出`intersection: one point`，然后在下一行输出该点编号和坐标。

   若直线与凸包交于$2$点，输出`intersection: two points`，然后在后面的两行从小到大依次输出这两个点的编号和坐标。

   若直线于凸包交于一根线段，输出`intersection: segment`，然后在后面的两行从小到大依次输出线段两个端点的编号和坐标。

## Constraints

对于询问3,4保证询问点非原点。

## Tutorial

点凸包:

定义排序函数：

```cpp
struct vec { ll x, y; };
bool operator<(vec a, vec b) { return a.x == b.x ? a.y < b.y : a.x < b.x; }
bool operator>(vec a, vec b) { return a.x == b.x ? a.y > b.y : a.x > b.x; }
```

对于上下两个凸壳，分别利用`set`维护一个环状链表。下凸壳按`less<vec>`排，上凸壳按`greater<vec>`排。

满足条件：对于任意相邻三点`uvw`有`crx(u,v,w)>0`。（逆时针）

对于下凸壳，`a pr b`当且仅当`a`在`b`的左边或`a`在`b`的正下方。

对于上凸壳，`a pr b`当且仅当`a`在`b`的右边或`a`在`b`的正上方。

下凸壳横坐标为最小值的点只有一个，最大值的点至多只有两个。

上凸壳横坐标为最大值的点只有一个，最小值的点至多只有两个。

点在上/下凸壳外当且仅当其小于左端点或大于右端点，或在凸壳正上/下方。

点在上/下凸壳内当且仅当其大于左端点且小于右端点，且在凸壳正下/上方。

点在凸壳上当且仅当其在折线上。

### 寻找点在凸壳上的前驱后继

比较函数为`[&](int i, int j) { return pr()(w[i], w[j]); }`

若点小于`min()`，则`lower_bound`返回`begin()`。此时没有前驱，否则前驱为`prev(*it)`。

若点大于`max()`，则`lower_bound`返回`end()`。此时没有后继，否则后继为`*it`。

### 判断点是否在凸包内

如果其小于`min()`或大于`max()`，则点在凸壳外，返回$1$。

否则寻找`v`的前驱`prv(v)`和后继`nxt(v)`，并记录`crx(prv(v), v, nxt(v))`的符号。

由前驱后继的关系，必有`prv(v)<=v<=nxt(v)` 。

若为$0$，则此时点在线段`prv(v)`-`nxt(v)`上。

若为$1$，则点在凸壳外。若为$-1$，则点在凸壳内。

对于整个凸包，点在凸包内当且仅当点同时在两个凸壳内。

点在凸壳外当且仅当其在某个凸壳外。可以画出状态表：

```
*  -1  0  1
-1 -1  0  1
0   0  0  x  
1   1  x  1
```

`x`表示不可能。因此整个凸包的结果为两个凸壳的结果取最大值。

### 插入

分别插入两个凸壳。

若其有前驱，则依次将不满足凸性的前驱删除。

若其有后继，则依次将不满足凸性的后继删除。

将其插入链表。

### 点/叉积最大

点积最大可以与叉积最大互相转化。

对点`v`求叉积最大需要修改`set`的比较函数。

上凸壳折线段的幅角取值是$(0,\pi]$。下凸壳折线段的幅角取值是$(\pi,2\pi]$。

考虑凸壳上的点`p`。若`v^nxt(p)>v^p`，则`v^(nxt(p)-p)>0`。

叉积最大点即第一个满足`v^(nxt(p)-p)<=0`的点。

考虑到`max()`没有后继，因此没有后继的点恒返回`false`。

因此比较函数为`v^(nxt(p)-p)>0`。

### 左右切线

左切点即满足`crx(v,p,nxt(p))<=0&&crx(v,p,prv(p))<=0`的点。

右切点即满足`crx(v,p,nxt(p))>=0&&crx(v,p,prv(p))>=0`的点。





线凸包：

对于下凸壳，将直线记为$y=kx+b$。用`set`按$k$从小到大排。

设一条线$l$为$(k,b)$，其前面的线$l_1$是$(k_1,b_1)$，后面的线$l_2$是$(k_2,b_2)$。

若$k=k_2$且$b<b_2$，则应将$l$踢出。

若$k_1=k$且$b_1<b$，则应将$l_1$踢出。

之后有$k_1<k<k_2$。

其与前后两线交点是
$$
x_1=\frac{b_1-b}{k-k_1},x_2=\frac{b-b_2}{k_2-k}
$$
其应留下当且仅当$x_1<x_2$，即$(b_1-b)(k_2-k)<(b-b_2)(k-k_1)$。

整理得$(b_1-b)(k_2-k)<(b_2-b)(k_1-k)$。







## Data generation

```
gen 100 1000 20000 0.002
```





